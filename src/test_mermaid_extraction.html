<!DOCTYPE html>
<html>
<head>
    <title>Test Mermaid Extraction</title>
</head>
<body>
    <div class="chat-turn-container code-block-aligner model render">
        <div class="turn-content">
            <ms-code-block class="ng-star-inserted">
                <div class="container">
                    <mat-expansion-panel class="mat-expansion-panel sticky-header mat-expanded mat-expansion-panel-animations-enabled">
                        <mat-expansion-panel-header class="mat-expansion-panel-header mat-focus-indicator sticky mat-expanded">
                            <span class="mat-content">
                                <mat-panel-title class="mat-expansion-panel-header-title">
                                    <span aria-hidden="true" class="material-symbols-outlined notranslate title-icon"> code </span>
                                    <span>JSON</span>
                                </mat-panel-title>
                            </span>
                        </mat-expansion-panel-header>
                        <div class="mat-expansion-panel-content-wrapper">
                            <div class="mat-expansion-panel-content">
                                <div class="mat-expansion-panel-body">
                                    <div aria-hidden="true" class="ignore-when-copying">IGNORE_WHEN_COPYING_START</div>
                                    <div aria-hidden="true" class="ignore-when-copying">IGNORE_WHEN_COPYING_END</div>
                                    <pre class="ng-star-inserted">
                                        <code>{
  "type": "gitGraph",
  "actions": [
    {
      "type": "commit",
      "branch": "main",
      "id": "turn-B915CFDD-3C88-437F-8591-44F0AD869CDC",
      "message": "Greeting | User starts conversation",
      "branch_hint": "Greeting"
    },
    {
      "type": "commit",
      "branch": "main",
      "id": "turn-46603130-4ED3-4C56-8239-83D8A999A842",
      "message": "Greeting | Model responds",
      "branch_hint": "Greeting"
    },
    {
      "type": "branch",
      "name": "Weather Request",
      "from": "main"
    },
    {
      "type": "checkout",
      "name": "Weather Request"
    },
    {
      "type": "commit",
      "branch": "Weather Request",
      "id": "turn-9F3CD175-D0A2-4134-B0BF-350A5C3B74CC",
      "message": "Weather Request | User asks for weather in Gdansk",
      "branch_hint": "Weather Request"
    },
    {
      "type": "commit",
      "branch": "Weather Request",
      "id": "turn-06A5B4F0-BA94-45E2-80BB-2D110BCA5272",
      "message": "Weather Request | Model provides detailed forecast",
      "branch_hint": "Weather Request"
    },
    {
      "type": "branch",
      "name": "Dinner Ideas",
      "from": "Weather Request"
    },
    {
      "type": "checkout",
      "name": "Dinner Ideas"
    },
    {
      "type": "commit",
      "branch": "Dinner Ideas",
      "id": "turn-A31845FD-8DFC-4D8C-B26E-2806D13DEC6D",
      "message": "Dinner Ideas | User asks for family dinner suggestions",
      "branch_hint": "Dinner Ideas"
    },
    {
      "type": "commit",
      "branch": "Dinner Ideas",
      "id": "turn-1D23723D-AAB9-42EA-A4A8-24F927190635",
      "message": "Dinner Ideas | Model gives categorized meal ideas",
      "branch_hint": "Dinner Ideas"
    }
  ]
}</code>
                                    </pre>
                                </div>
                            </div>
                        </div>
                    </mat-expansion-panel>
                </div>
            </ms-code-block>
            <ms-code-block class="ng-star-inserted">
                <div class="container">
                    <mat-expansion-panel class="mat-expansion-panel sticky-header mat-expanded mat-expansion-panel-animations-enabled">
                        <mat-expansion-panel-header class="mat-expansion-panel-header mat-focus-indicator sticky mat-expanded">
                            <span class="mat-content">
                                <mat-panel-title class="mat-expansion-panel-header-title">
                                    <span aria-hidden="true" class="material-symbols-outlined notranslate title-icon"> code </span>
                                    <span>Mermaid</span>
                                </mat-panel-title>
                            </span>
                        </mat-expansion-panel-header>
                        <div class="mat-expansion-panel-content-wrapper">
                            <div class="mat-expansion-panel-content">
                                <div class="mat-expansion-panel-body">
                                    <div aria-hidden="true" class="ignore-when-copying">IGNORE_WHEN_COPYING_START</div>
                                    <div aria-hidden="true" class="ignore-when-copying">IGNORE_WHEN_COPYING_END</div>
                                    <pre class="ng-star-inserted">
                                        <code>gitGraph
   commit message: "Greeting"
   commit message: "Greeting"
   branch "Weather Request"
   commit message: "Weather Request"
   commit message: "Weather Request"
   branch "Dinner Ideas"
   commit message: "Dinner Ideas"
   commit message: "Dinner Ideas"</code>
                                    </pre>
                                </div>
                            </div>
                        </div>
                    </mat-expansion-panel>
                </div>
            </ms-code-block>
        </div>
    </div>

    <script>
        // Copy the extraction function from content_script.js
        function extractJsonAndMermaidFromDom(turnRoot) {
            try {
                const result = { json: null, mermaid: null };
                // First, prefer panels inside ms-code-block
                let panels = Array.from(turnRoot.querySelectorAll('ms-code-block .mat-expansion-panel'));
                console.log(`Found ${panels.length} expansion panels in ms-code-block elements`);
                // If none found, fall back to any expansion panel within the turn
                if (panels.length === 0) {
                    panels = Array.from(turnRoot.querySelectorAll('.mat-expansion-panel'));
                    console.log(`Fallback - Found ${panels.length} expansion panels within the turn`);
                }
                
                panels.forEach((panel, index) => {
                    const titleEl = panel.querySelector('.mat-expansion-panel-header .mat-expansion-panel-header-title');
                    // Get the text content, but exclude the icon text (like "code")
                    let title = '';
                    if (titleEl) {
                        const spans = titleEl.querySelectorAll('span');
                        for (const span of spans) {
                            const text = span.textContent.trim();
                            // Skip icon text (usually single words like "code")
                            if (text && text.length > 1 && !text.includes('code')) {
                                title = text;
                                break;
                            }
                        }
                        // Fallback to full text content if no specific span found
                        if (!title) {
                            title = titleEl.textContent.trim();
                        }
                    }
                    const codeEl = panel.querySelector('pre code');
                    if (!codeEl) {
                        console.log(`Panel ${index + 1} has no code element`);
                        return;
                    }
                    let code = codeEl.textContent || '';
                    console.log(`Panel ${index + 1} title: "${title}", code length: ${code.length}`);
                    console.log(`Panel ${index + 1} title elements:`, titleEl ? titleEl.innerHTML : 'none');
                    console.log(`Panel ${index + 1} code preview:`, code.substring(0, 100) + '...');
                    
                    // Strip helper markers and zero-width spaces/highlights
                    code = code.replace(/IGNORE_WHEN_COPYING_START[\s\S]*?IGNORE_WHEN_COPYING_END/g, '');
                    code = code.replace(/\u200B/g, '');
                    
                    if (/^JSON$/i.test(title)) {
                        console.log(`Processing JSON panel ${index + 1}`);
                        // Find first balanced JSON object
                        const json = extractFirstBalancedJson(code);
                        if (json && !result.json) {
                            result.json = json;
                            console.log(`Extracted JSON from panel ${index + 1}, length: ${json.length}`);
                        }
                        // If Mermaid is embedded after JSON, capture it
                        if (!result.mermaid) {
                            const idx = code.indexOf('gitGraph');
                            if (idx !== -1) {
                                result.mermaid = code.substring(idx).replace(/```/g, '').trim();
                                console.log(`Found embedded Mermaid in JSON panel ${index + 1}`);
                            }
                        }
                    } else if (/^Mermaid$/i.test(title)) {
                        console.log(`Processing Mermaid panel ${index + 1}`);
                        if (!result.mermaid) {
                            result.mermaid = code.replace(/```/g, '').trim();
                            console.log(`Extracted Mermaid from panel ${index + 1}, length: ${result.mermaid.length}`);
                        }
                    }
                });
                
                // Fallback: If still no JSON or Mermaid, scan all raw <pre><code> blocks
                if (!result.json || !result.mermaid) {
                    console.log('Fallback - scanning raw code blocks for JSON/Mermaid');
                    const allCodeBlocks = turnRoot.querySelectorAll('pre code');
                    console.log(`Fallback - found ${allCodeBlocks.length} raw code blocks`);
                    allCodeBlocks.forEach((codeEl, index) => {
                        if (result.json && result.mermaid) return; // Stop if both found
                        let code = codeEl.textContent || '';
                        code = code.replace(/IGNORE_WHEN_COPYING_START[\s\S]*?IGNORE_WHEN_COPYING_END/g, '');
                        code = code.replace(/\u200B/g, '');
                        
                        if (!result.json) {
                            const json = extractFirstBalancedJson(code);
                            if (json) {
                                result.json = json;
                                console.log(`Fallback - extracted JSON from raw block ${index + 1}`);
                            }
                        }
                        if (!result.mermaid) {
                            const idx = code.indexOf('gitGraph');
                            if (idx !== -1) {
                                result.mermaid = code.substring(idx).replace(/```/g, '').trim();
                                console.log(`Fallback - extracted Mermaid from raw block ${index + 1}`);
                            }
                        }
                    });
                }
                
                console.log(`Final extraction result - JSON: ${!!result.json}, Mermaid: ${!!result.mermaid}`);
                return result;
            } catch (error) {
                console.error('Error in extractJsonAndMermaidFromDom:', error);
                return { json: null, mermaid: null };
            }
        }

        // Brace-balanced JSON slice extractor
        function extractFirstBalancedJson(text) {
            const start = text.indexOf('{');
            if (start === -1) return null;
            let depth = 0;
            for (let i = start; i < text.length; i++) {
                const ch = text[i];
                if (ch === '{') depth++;
                else if (ch === '}') depth--;
                if (depth === 0) {
                    const slice = text.substring(start, i + 1);
                    try { JSON.parse(slice); return slice; } catch (_) { return null; }
                }
            }
            return null;
        }

        // Test the extraction
        console.log('=== TESTING MERMAID EXTRACTION ===');
        const turnRoot = document.querySelector('.chat-turn-container');
        const result = extractJsonAndMermaidFromDom(turnRoot);
        
        console.log('=== RESULTS ===');
        console.log('JSON extracted:', !!result.json);
        console.log('Mermaid extracted:', !!result.mermaid);
        
        if (result.json) {
            console.log('JSON preview:', result.json.substring(0, 200) + '...');
        }
        
        if (result.mermaid) {
            console.log('Mermaid preview:', result.mermaid.substring(0, 200) + '...');
        }
        
        // Test the popup fallback function
        function tryExtractMermaidFromJson(jsonText) {
            if (!jsonText || typeof jsonText !== 'string') return null;
            // If someone stored JSON and Mermaid in one blob, locate gitGraph segment
            const backtickClean = jsonText.replace(/```/g, '');
            const idx = backtickClean.indexOf('gitGraph');
            if (idx === -1) return null;
            const tail = backtickClean.substring(idx);
            // Stop at next closing fence if present (best-effort)
            const fenceIdx = tail.indexOf('```');
            const mermaid = (fenceIdx !== -1 ? tail.substring(0, fenceIdx) : tail).trim();
            return mermaid.startsWith('gitGraph') ? mermaid : null;
        }
        
        console.log('=== TESTING POPUP FALLBACK ===');
        const fallbackMermaid = tryExtractMermaidFromJson(result.json);
        console.log('Fallback Mermaid from JSON:', !!fallbackMermaid);
        if (fallbackMermaid) {
            console.log('Fallback Mermaid preview:', fallbackMermaid.substring(0, 200) + '...');
        }
    </script>
</body>
</html>
